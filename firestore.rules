rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isParentOf(childId) {
      return get(/databases/$(database)/documents/users/$(childId)).data.parentUid == request.auth.uid;
    }

    function isAdmin() {
      return isSignedIn() && (
        request.auth.uid == 'admin-mock-id' || 
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super_admin'])
      );
    }

    function isSuperAdmin() {
      return isSignedIn() && (
        request.auth.uid == 'admin-mock-id' || 
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin')
      );
    }

    // Users Collection
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && (
        isOwner(userId) || 
        isParentOf(userId) || 
        isAdmin() ||
        (request.resource.data.role == 'super_admin' && isSuperAdmin())
      );
      allow delete: if isAdmin();

      // Sub-collection for children profiles
      match /children/{childId} {
        allow read: if isSignedIn() && (isOwner(userId) || isAdmin());
        allow create: if isSignedIn() && isOwner(userId);
        allow update: if isSignedIn() && (isOwner(userId) || isAdmin());
        allow delete: if isSignedIn() && (isOwner(userId) || isAdmin());
      }

      // Sub-collection for approvals
      match /approvals/{approvalId} {
        allow read: if isSignedIn() && (isOwner(userId) || isAdmin());
        allow create: if isSignedIn();
        allow update: if isSignedIn() && (isOwner(userId) || isAdmin());
        allow delete: if isSignedIn() && (isOwner(userId) || isAdmin());
      }

      // Sub-collection for notifications
      match /notifications/{notiId} {
        allow read: if isSignedIn() && isOwner(userId);
        allow create: if isAdmin();
        allow update: if isSignedIn() && isOwner(userId);
        allow delete: if isSignedIn() && isOwner(userId);
      }
    }

    // Posts Collection
    match /posts/{postId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
    }

    // Direct Video Assets
    match /videos/{videoId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // Squads Collection
    match /squads/{squadId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.creatorId == request.auth.uid;
      allow update: if isSignedIn() && (
        request.auth.uid == resource.data.creatorId || 
        isAdmin() ||
        // Allow users to add themselves to members array
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberCount', 'members']) &&
         request.resource.data.members.hasAll(resource.data.members))
      );
      allow delete: if isAdmin();
    }

    match /squadMembers/{memberId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() && (request.auth.uid == (resource == null ? request.resource.data.userId : resource.data.userId) || isAdmin());
    }

    match /squadChallenges/{challengeId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin() || (exists(/databases/$(database)/documents/squads/$(resource.data.squadId)) && get(/databases/$(database)/documents/squads/$(resource.data.squadId)).data.creatorId == request.auth.uid);
    }

    // Legacy Notifications (Redirected to Sub-collections now)
    match /notifications/{notiId} {
      allow read: if isSignedIn() && isOwner(resource.data.userId);
      allow create: if isAdmin();
      allow update, delete: if isSignedIn() && isOwner(resource.data.userId);
    }

    // Admin Logs
    match /admin_logs/{logId} {
      allow read, create: if isAdmin();
      allow update, delete: if false;
    }

    // Verification Requests
    match /verificationRequests/{requestId} {
      allow read: if isAdmin();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Verification Attempts (Ondato)
    match /verification_attempts/{attemptId} {
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if true; // isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if false; // Only Cloud Functions should update status (via admin SDK)
      allow delete: if isAdmin();
    }

    // Transactions Collection (Rewards System)
    match /transactions/{transactionId} {
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if false; // Transactions are immutable
      allow delete: if isAdmin();
    }

    // Daily Progress Collection (Rewards System)
    match /users/{userId}/daily_progress/{progressId} {
      allow read: if isSignedIn() && (isOwner(userId) || isAdmin());
      allow create, update: if isSignedIn() && isOwner(userId);
      allow delete: if isAdmin();
    }

    // Approvals Collection (Parent-Child Spending)
    match /approvals/{approvalId} {
      allow read: if isSignedIn() && (
        resource.data.childId == request.auth.uid || 
        resource.data.parentId == request.auth.uid || 
        isAdmin()
      );
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (
        resource.data.parentId == request.auth.uid || 
        isAdmin()
      );
      allow delete: if isAdmin();
    }

    // Video Upload Workaround for blocked ingress
    match /vid_upload_requests/{reqId} {
      allow read, create: if isSignedIn() && (request.resource.data.userId == request.auth.uid || resource.data.userId == request.auth.uid);
      allow update, delete: if false;
    }
    match /vid_finalization_requests/{reqId} {
      allow read, create: if isSignedIn() && (request.resource.data.userId == request.auth.uid || resource.data.userId == request.auth.uid);
      allow update, delete: if false;
    }

    // Likes Collection
    match /likes/{likeId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow update: if false; // Likes are immutable
    }

    // Comments Collection
    match /comments/{commentId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // Following Collection
    match /following/{followId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.followerId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.followerId == request.auth.uid;
      allow update: if false; // Following relationships are immutable
    }

    // Squad Creation Waitlist
    match /squad_creation_waitlist/{requestId} {
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin() || (
        isSignedIn() && 
        resource.data.userId == request.auth.uid && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt']) && 
        request.resource.data.status == 'revoked'
      );
      allow delete: if isAdmin();
    }

    // Mentor Waitlist
    match /mentor_waitlist/{requestId} {
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin() || (
        isSignedIn() && 
        resource.data.userId == request.auth.uid && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt']) && 
        request.resource.data.status == 'revoked'
      );
      allow delete: if isAdmin();
    }

    // Global Config
    match /config/{configId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
  }
}
